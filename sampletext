// EMAX Genesis Pro: Multi-Exit (TP/SL/Trailing) Black-Box Strategy

using System;
using System.Windows.Media;
using NinjaTrader.Cbi;
using NinjaTrader.Gui.Tools;
using NinjaTrader.Gui.Chart;
using NinjaTrader.NinjaScript;
using NinjaTrader.Data;
using NinjaTrader.NinjaScript.Strategies;
using NinjaTrader.NinjaScript.Indicators;
using NinjaTrader.NinjaScript.DrawingTools;

namespace NinjaTrader.NinjaScript.Strategies
{
    public class EMAX_Genesis_Pro : Strategy
    {
        // --- Product-Style Properties ---
        [NinjaScriptProperty]
        public bool TradeGuardStandard { get; set; }
        [NinjaScriptProperty]
        public bool TradeGuardDynamic { get; set; }
        [NinjaScriptProperty]
        public bool TargetLock { get; set; }
        [NinjaScriptProperty]
        public bool SafetyNet { get; set; }
        [NinjaScriptProperty]
        public bool EnableSessionFilter { get; set; }
        [NinjaScriptProperty]
        public TimeSpan SessionStartTime { get; set; }
        [NinjaScriptProperty]
        public TimeSpan SessionEndTime { get; set; }
        [NinjaScriptProperty]
        public bool DailyGoalLock { get; set; }
        [NinjaScriptProperty]
        public double DailyProfitGoal { get; set; }
        [NinjaScriptProperty]
        public bool DailyRiskGuard { get; set; }
        [NinjaScriptProperty]
        public double DailyMaxLoss { get; set; }
        [NinjaScriptProperty]
        public bool ManualCloseAutoContinue { get; set; }
        [NinjaScriptProperty]
        public int TakeProfitTicks { get; set; }
        [NinjaScriptProperty]
        public int StopLossTicks { get; set; }

        // --- New: Trailing Stop Feature ---
        [NinjaScriptProperty]
        public bool TrailingStop { get; set; }
        [NinjaScriptProperty]
        public int TrailingStopWindow { get; set; }

        // --- Internal ---
        private EMA ema10, ema21, ema55;
        private string lastSignal = "None";
        private double sessionPnL = 0;
        private double priorRealized = 0;
        private DateTime currentSession = Core.Globals.MinDate;
        private bool hitDailyProfit = false;
        private bool hitDailyStop = false;
        private bool manualFlatDetected = false;
        private bool strategyInitiatedExit = false;
        private MarketPosition lastMarketPosition = MarketPosition.Flat;

        protected override void OnStateChange()
        {
            if (State == State.SetDefaults)
            {
                Name = "EMAX_Genesis_Pro";
                Calculate = Calculate.OnBarClose;
                IsOverlay = true;
                TradeGuardStandard = true;
                TradeGuardDynamic = false;
                TargetLock = false;
                SafetyNet = false;
                EnableSessionFilter = false;
                SessionStartTime = new TimeSpan(9, 30, 0); // 9:30 AM
                SessionEndTime = new TimeSpan(16, 0, 0);   // 4:00 PM
                DailyGoalLock = false;
                DailyProfitGoal = 500.0;
                DailyRiskGuard = false;
                DailyMaxLoss = 500.0;
                ManualCloseAutoContinue = false;
                TakeProfitTicks = 40;
                StopLossTicks = 20;
                TrailingStop = false;
                TrailingStopWindow = 10;
            }
            else if (State == State.DataLoaded)
            {
                ema10 = EMA(10);
                ema21 = EMA(21);
                ema55 = EMA(55);
                sessionPnL = 0;
                priorRealized = 0;
                currentSession = Core.Globals.MinDate;
                hitDailyProfit = false;
                hitDailyStop = false;
                manualFlatDetected = false;
                strategyInitiatedExit = false;
                lastMarketPosition = MarketPosition.Flat;
            }
        }

        protected override void OnBarUpdate()
        {
            if (CurrentBar < Math.Max(55, TrailingStopWindow)) return;

            // --- Session Filter ---
            if (EnableSessionFilter)
            {
                TimeSpan now = Time[0].TimeOfDay;
                if (now < SessionStartTime || now > SessionEndTime)
                    return; // Not in session
            }

            // --- New Session Reset ---
            DateTime barTime = Time[0];
            if (currentSession.Date != barTime.Date)
            {
                sessionPnL = 0;
                priorRealized = SystemPerformance.AllTrades.TradesPerformance.Currency.CumProfit;
                hitDailyProfit = false;
                hitDailyStop = false;
                manualFlatDetected = false;
                strategyInitiatedExit = false;
                lastMarketPosition = MarketPosition.Flat;
                lastSignal = "None";
            }

            // --- Update Session PnL ---
            sessionPnL = SystemPerformance.AllTrades.TradesPerformance.Currency.CumProfit - priorRealized;

            // --- Daily Stop/Profit Enforcement ---
            if (DailyGoalLock && !hitDailyProfit && sessionPnL >= DailyProfitGoal)
            {
                hitDailyProfit = true;
                Print("Daily goal hit: Trading paused for today.");
            }
            if (DailyRiskGuard && !hitDailyStop && sessionPnL <= -Math.Abs(DailyMaxLoss))
            {
                hitDailyStop = true;
                Print("Daily max loss hit: Trading paused for today.");
            }
            if ((hitDailyProfit || hitDailyStop) && Position.MarketPosition == MarketPosition.Flat)
                return; // Don't enter new trades

            // --- Robust Manual Flat Detection (fixed) ---
            if (lastMarketPosition != MarketPosition.Flat && Position.MarketPosition == MarketPosition.Flat)
            {
                // Just transitioned from position to flat
                if (!strategyInitiatedExit)
                {
                    manualFlatDetected = true;
                    if (!ManualCloseAutoContinue)
                    {
                        Print("Manual flat detected: Strategy will now stop trading logic until next day.");
                        lastMarketPosition = Position.MarketPosition; // update
                        return;
                    }
                }
                // Whether manual or strategy exit, reset for next position
                strategyInitiatedExit = false;
            }
            if (Position.MarketPosition != MarketPosition.Flat)
                manualFlatDetected = false; // Reset as soon as a new position is open

            // Save last position for next bar
            lastMarketPosition = Position.MarketPosition;

            // --- Arm/Disarm TP/SL for new trades (NT8 managed requirement) ---
            if (TargetLock && Position.MarketPosition == MarketPosition.Flat)
                SetProfitTarget(CalculationMode.Ticks, TakeProfitTicks);
            else
                SetProfitTarget(CalculationMode.Ticks, double.NaN);

            if (SafetyNet && Position.MarketPosition == MarketPosition.Flat)
                SetStopLoss(CalculationMode.Ticks, StopLossTicks);
            else
                SetStopLoss(CalculationMode.Ticks, double.NaN);

            // --- Entry Logic (Black Box) ---
            if (!hitDailyProfit && !hitDailyStop && !manualFlatDetected)
            {
                if (CrossAbove(ema10, ema55, 1))
                {
                    EnterLong("Long");
                    lastSignal = "Long";
                    PlaySound(NinjaTrader.Core.Globals.InstallDir + @"\sounds\Alert3.wav");
                }
                if (CrossBelow(ema10, ema55, 1))
                {
                    EnterShort("Short");
                    lastSignal = "Short";
                    PlaySound(NinjaTrader.Core.Globals.InstallDir + @"\sounds\Alert3.wav");
                }
            }

            // --- Exit Logic (Standard/Dynamic/Trailing) ---
            if (Position.MarketPosition == MarketPosition.Long)
            {
                // Standard Exit
                if (TradeGuardStandard && CrossBelow(ema10, ema55, 1))
                {
                    strategyInitiatedExit = true;
                    ExitLong("StdExit");
                    lastSignal = "Exit Long - Std";
                }
                // Dynamic Exit
                if (TradeGuardDynamic && CrossBelow(ema10, ema21, 1))
                {
                    strategyInitiatedExit = true;
                    ExitLong("DynExit");
                    lastSignal = "Exit Long - Dynamic";
                }
                // Trailing Stop (Bar-Low)
                if (TrailingStop)
                {
                    double chandLow = MIN(Low, TrailingStopWindow)[0];
                    if (Close[0] < chandLow)
                    {
                        strategyInitiatedExit = true;
                        ExitLong("TrailingStop");
                        lastSignal = $"Exit Long - Trail ({TrailingStopWindow})";
                    }
                }
            }
            if (Position.MarketPosition == MarketPosition.Short)
            {
                // Standard Exit
                if (TradeGuardStandard && CrossAbove(ema10, ema55, 1))
                {
                    strategyInitiatedExit = true;
                    ExitShort("StdExit");
                    lastSignal = "Exit Short - Std";
                }
                // Dynamic Exit
                if (TradeGuardDynamic && CrossAbove(ema10, ema21, 1))
                {
                    strategyInitiatedExit = true;
                    ExitShort("DynExit");
                    lastSignal = "Exit Short - Dynamic";
                }
                // Trailing Stop (Bar-High)
                if (TrailingStop)
                {
                    double chandHigh = MAX(High, TrailingStopWindow)[0];
                    if (Close[0] > chandHigh)
                    {
                        strategyInitiatedExit = true;
                        ExitShort("TrailingStop");
                        lastSignal = $"Exit Short - Trail ({TrailingStopWindow})";
                    }
                }
            }
        }

        protected override void OnRender(ChartControl chartControl, ChartScale chartScale)
        {
            base.OnRender(chartControl, chartScale);

            // --- Dashboard Open PnL Fix ---
            // Use Position.GetUnrealizedProfitLoss only if in a position, otherwise show "—"
            string openPnLText = "—";
            if (Position.MarketPosition != MarketPosition.Flat)
                openPnLText = Position.GetUnrealizedProfitLoss(PerformanceUnit.Currency, Close[0]).ToString("F2");

            string dashText =
                "EMAX Genesis Pro\n" +
                "Trade Guard: " + (TradeGuardDynamic ? "Dynamic" : "Standard") + "\n" +
                "Trailing Stop: " + (TrailingStop ? $"On ({TrailingStopWindow} bars)" : "Off") + "\n" +
                "Session: " + (EnableSessionFilter ? $"{SessionStartTime:hh\\:mm}-{SessionEndTime:hh\\:mm}" : "All") + "\n" +
                "Daily PnL: " + sessionPnL.ToString("C0") +
                (DailyGoalLock ? $" | Goal: {DailyProfitGoal:C0}" : "") +
                (DailyRiskGuard ? $" | Max Loss: -{DailyMaxLoss:C0}" : "") + "\n" +
                "Status: " +
                (hitDailyProfit ? "Goal Hit" : hitDailyStop ? "Max Loss Hit" : manualFlatDetected ? "Manual Close" : "Active") + "\n" +
                "Position: " +
                (Position.MarketPosition == MarketPosition.Long ? "Long" :
                 Position.MarketPosition == MarketPosition.Short ? "Short" : "Flat") + "\n" +
                "Avg Price: " +
                (Position.MarketPosition != MarketPosition.Flat ? Position.AveragePrice.ToString("F2") : "—") + "\n" +
                "Open PnL: " + openPnLText + "\n" +
                "Last Signal: " + lastSignal;

            Draw.TextFixed(this, "EMAX_DASH", dashText, TextPosition.BottomRight);
        }
    }
}