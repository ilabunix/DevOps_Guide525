<script>
  async function askBot() {
    const queryInput = document.getElementById("query");
    const query = queryInput.value.trim();
    const responseBox = document.getElementById("responseBox");

    if (!query) {
      responseBox.textContent = "Please enter a question.";
      return;
    }

    // Add user message as a bubble
    responseBox.innerHTML += `
      <div style="text-align:right; margin: 0.5rem 0;">
        <div style="display:inline-block; background:#DCF8C6; color:#000; padding:0.75rem 1rem; border-radius:16px 16px 0 16px; max-width:70%;">
          ${query}
        </div>
      </div>
    `;

    queryInput.value = "";
    responseBox.innerHTML += `<div style="text-align:left; color:#888; margin:0.5rem 0;">Bot is typing...</div>`;

    try {
      const res = await fetch("https://3vdty0ekf8.execute-api.us-west-2.amazonaws.com/prod/chatbot", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });

      const data = await res.json();
      responseBox.lastChild.remove(); // Remove "Bot is typing..."

      let answerText = "";
      if (data.answer && Array.isArray(data.answer)) {
        answerText = data.answer.map(item =>
          item.text || item.content || JSON.stringify(item)
        ).join("\n\n");
      } else if (typeof data.answer === "string") {
        answerText = data.answer;
      } else {
        answerText = JSON.stringify(data, null, 2);
      }

      const matchesHtml = data.matches?.length
        ? `
          <details style="margin-top:0.5rem;">
            <summary style="cursor:pointer;font-size:0.9rem;font-weight:bold;">Show Source Chunks</summary>
            <pre style="white-space:pre-wrap; font-size:0.85rem;">${data.matches.join("\n\n")}</pre>
          </details>
        `
        : "";

      // Add bot response bubble
      responseBox.innerHTML += `
        <div style="text-align:left; margin: 0.5rem 0;">
          <div style="display:inline-block; background:#F1F0F0; color:#000; padding:0.75rem 1rem; border-radius:16px 16px 16px 0; max-width:70%;">
            ${answerText.replace(/\n/g, "<br>")}
            ${matchesHtml}
          </div>
        </div>
      `;

      responseBox.scrollTop = responseBox.scrollHeight;
    } catch (error) {
      responseBox.innerHTML += `
        <div style="text-align:left; color:red; margin-top:1rem;">
          Error: ${error.message}
        </div>
      `;
    }
  }
</script>